name: '[CI] Continuous Integration'

on:
    workflow_dispatch:
    schedule:
        - cron: '0 0 * * *' # Runs every day at midnight UTC

permissions:
    contents: write
    pull-requests: write

jobs:
    chore-dependencies:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v3
              with:
                  ref: dev
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '16'

            - name: Install dependencies
              run: |
                  npm install

            - name: Update dependencies
              run: |
                  npx npm-check-updates -u
                  npm install

            - name: Create Pull Request
              uses: peter-evans/create-pull-request@v5
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  branch: auto/update-deps
                  base: dev
                  title: 'chore: update dependencies'
                  body: 'Automated dependency update'
                  commit-message: 'chore: update dependencies'
                  labels: 'chore'
                  delete-branch: true

            - name: Auto-merge PR
              if: success()
              uses: pascalgn/automerge-action@v0.16.3
              with:
                  merge_method: squash
                  github_token: ${{ secrets.GITHUB_TOKEN }}

    chore-prettier:
        runs-on: ubuntu-latest
        needs: chore-dependencies

        steps:
            - name: Checkout repository
              uses: actions/checkout@v3
              with:
                  ref: dev
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Install Prettier
              run: |
                  npm install -g prettier

            - name: Format JSON files using Prettier
              run: |
                  prettier --write . --ignore-path .prettierignore

            - name: Create Pull Request
              uses: peter-evans/create-pull-request@v5
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  branch: auto/format-prettier
                  base: dev
                  title: 'chore: format files with prettier'
                  body: 'Automated file formatting with Prettier'
                  commit-message: 'chore: format files with prettier'
                  labels: 'chore'
                  delete-branch: true

            - name: Auto-merge PR
              if: success()
              uses: pascalgn/automerge-action@v0.16.3
              with:
                  merge_method: squash
                  github_token: ${{ secrets.GITHUB_TOKEN }}
